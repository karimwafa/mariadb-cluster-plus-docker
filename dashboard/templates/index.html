<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MariaDB Replication Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        .connector-line {
            position: absolute;
            z-index: -1;
            background-color: #94a3b8;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .status-up {
            animation: pulse-green 2s infinite;
            border-color: #22c55e;
        }

        .status-down {
            border-color: #ef4444;
        }

        .status-issues {
            border-color: #eab308;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">


        <!-- Topology View -->
        <div class="relative bg-gray-800 rounded-xl p-8 shadow-2xl mb-12 border border-gray-700">
            <h2 class="text-xl font-semibold mb-8 text-gray-300 border-b border-gray-700 pb-2">Cluster Topology</h2>

            <div class="flex flex-col items-center relative gap-8">
                <!-- ProxySQL Node -->
                <div id="node-proxysql"
                    class="w-56 bg-purple-900 rounded-lg p-5 border-l-4 border-purple-500 shadow-2xl text-center z-20 hover:scale-105 transition-transform duration-300">
                    <div class="text-xs text-purple-300 font-bold mb-1">LOAD BALANCER</div>
                    <i class="fa-solid fa-network-wired text-5xl mb-3 text-purple-400"></i>
                    <div class="font-bold text-xl">ProxySQL</div>
                    <div class="text-xs text-gray-400 mt-1 status-text">Checking...</div>
                    <div class="mt-2 text-[10px] text-gray-400 bg-gray-800 rounded px-2 py-1">Port 6033 (SQL) / 6032
                        (Admin)</div>
                </div>

                <!-- Vertical connector from ProxySQL -->
                <div class="h-8 w-1 bg-gray-600 -my-4 relative z-0"></div>

                <!-- Master Node -->
                <div id="node-master"
                    class="w-48 bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500 shadow-lg text-center z-10 transition-all duration-300">
                    <div class="text-xs text-blue-300 font-bold mb-1">WRITE MASTER</div>
                    <i class="fa-solid fa-database text-4xl mb-2 text-blue-500"></i>
                    <div class="font-bold text-lg">Master</div>
                    <div class="text-xs text-gray-400 mt-1 status-text">Checking...</div>
                </div>

                <!-- Connectors to Slaves -->
                <div class="relative w-full h-12">
                    <div class="absolute left-1/2 top-0 h-6 w-0.5 bg-gray-600 -translate-x-1/2"></div>
                    <!-- Down from Master -->
                    <div class="absolute top-6 left-[16%] right-[16%] h-0.5 bg-gray-600"></div> <!-- Horizontal bar -->
                    <div class="absolute top-6 left-[16%] h-6 w-0.5 bg-gray-600"></div> <!-- To Slave 1 -->
                    <div class="absolute top-6 left-1/2 h-6 w-0.5 bg-gray-600 -translate-x-1/2"></div>
                    <!-- To Slave 2 -->
                    <div class="absolute top-6 right-[16%] h-6 w-0.5 bg-gray-600"></div> <!-- To Slave 3 -->
                </div>

                <!-- Slave Nodes -->
                <div class="flex justify-between w-full px-4 lg:px-24">
                    <!-- Slave 1 -->
                    <div id="node-slave1"
                        class="w-40 bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500 shadow-lg text-center z-10">
                        <div class="text-xs text-green-300 font-bold mb-1">READ (Go)</div>
                        <i class="fa-solid fa-server text-3xl mb-2 text-gray-400"></i>
                        <div class="font-bold">Slave-1</div>
                        <div class="text-xs text-gray-400 mt-1 status-text">Checking...</div>
                    </div>

                    <!-- Slave 2 -->
                    <div id="node-slave2"
                        class="w-40 bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500 shadow-lg text-center z-10">
                        <div class="text-xs text-green-300 font-bold mb-1">READ (Express)</div>
                        <i class="fa-solid fa-server text-3xl mb-2 text-gray-400"></i>
                        <div class="font-bold">Slave-2</div>
                        <div class="text-xs text-gray-400 mt-1 status-text">Checking...</div>
                    </div>

                    <!-- Slave 3 -->
                    <div id="node-slave3"
                        class="w-40 bg-gray-700 rounded-lg p-4 border-l-4 border-gray-500 shadow-lg text-center z-10">
                        <div class="text-xs text-green-300 font-bold mb-1">READ (Laravel)</div>
                        <i class="fa-solid fa-server text-3xl mb-2 text-gray-400"></i>
                        <div class="font-bold">Slave-3</div>
                        <div class="text-xs text-gray-400 mt-1 status-text">Checking...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing Control Panel -->
        <h2 class="text-xl font-semibold mb-4 text-gray-300 pl-2 border-l-4 border-purple-500">Service Test Suite</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Go Service -->
            <div
                class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 hover:border-cyan-500 transition-colors">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-cyan-400"><i class="fa-brands fa-golang mr-2"></i>Go Service</h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Port 8081</span>
                </div>
                <p class="text-gray-400 text-sm mb-4">Writes to Master → Reads from Slave-1</p>
                <button onclick="runTest('go')"
                    class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded transition-colors flex justify-center items-center">
                    <i class="fa-solid fa-play mr-2"></i> Run Test
                </button>
                <div id="log-go"
                    class="mt-4 p-3 bg-gray-900 rounded text-xs text-green-400 font-mono h-32 overflow-y-auto hidden">
                </div>
            </div>

            <!-- Express Service -->
            <div
                class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 hover:border-green-500 transition-colors">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-green-400"><i class="fa-brands fa-node mr-2"></i>Express Service
                    </h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Port 8082</span>
                </div>
                <p class="text-gray-400 text-sm mb-4">Writes to Master → Reads from Slave-2</p>
                <button onclick="runTest('express')"
                    class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition-colors flex justify-center items-center">
                    <i class="fa-solid fa-play mr-2"></i> Run Test
                </button>
                <div id="log-express"
                    class="mt-4 p-3 bg-gray-900 rounded text-xs text-green-400 font-mono h-32 overflow-y-auto hidden">
                </div>
            </div>

            <!-- Laravel Service -->
            <div
                class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 hover:border-red-500 transition-colors">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-red-400"><i class="fa-brands fa-laravel mr-2"></i>Laravel Service
                    </h3>
                    <span class="bg-gray-700 text-xs px-2 py-1 rounded">Port 8000</span>
                </div>
                <p class="text-gray-400 text-sm mb-4">Writes to Master → Reads from Slave-3</p>
                <button onclick="runTest('laravel')"
                    class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition-colors flex justify-center items-center">
                    <i class="fa-solid fa-play mr-2"></i> Run Test
                </button>
                <div id="log-laravel"
                    class="mt-4 p-3 bg-gray-900 rounded text-xs text-green-400 font-mono h-32 overflow-y-auto hidden">
                </div>
            </div>



        </div>
        <!-- Queue/Buffer Visualization -->
        <!-- (Optional: Visually represent the buffer if needed, for now implicit in lag) -->

        <!-- Data Viewer Modal -->
        <div id="dataModal"
            class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-3/4 h-3/4 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 id="modalTitle" class="text-xl font-bold text-blue-400">Database Content</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="p-6 overflow-auto flex-1 text-gray-300">
                    <div class="flex justify-center items-center h-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const statusMap = {
                'master': document.getElementById('master-status'),
                'slave1': document.getElementById('slave1-status'),
                'slave2': document.getElementById('slave2-status'),
                'slave3': document.getElementById('slave3-status')
            };

            // Add click handlers to nodes for browsing
            document.addEventListener('DOMContentLoaded', () => {
                // Make nodes clickable
                const nodes = {
                    'master': document.getElementById('node-master'),
                    'slave1': document.getElementById('node-slave1'),
                    'slave2': document.getElementById('node-slave2'),
                    'slave3': document.getElementById('node-slave3'),
                };

                Object.keys(nodes).forEach(key => {
                    if (nodes[key]) {
                        nodes[key].style.cursor = 'pointer';
                        nodes[key].title = 'Click to browse data';
                        nodes[key].onclick = () => openModal(key);
                    }
                });
            });

            function openModal(node) {
                const modal = document.getElementById('dataModal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');

                modal.classList.remove('hidden');
                title.textContent = `Browsing Node: ${node.toUpperCase()}`;
                content.innerHTML = '<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';

                fetch(`/api/browse/${node}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            content.innerHTML = `<div class="text-red-500">Error: ${data.error}</div>`;
                            return;
                        }

                        if (Object.keys(data).length === 0) {
                            content.innerHTML = '<div class="text-gray-500 italic">No databases found.</div>';
                            return;
                        }

                        let html = '<div class="space-y-2">';
                        for (const [db, tables] of Object.entries(data)) {
                            const dbId = `db-${db}`;
                            html += `
                        <div class="border border-gray-700 rounded-lg overflow-hidden">
                            <button onclick="toggleAccordion('${dbId}')" class="w-full flex justify-between items-center p-4 bg-gray-800 hover:bg-gray-700 transition-colors">
                                <span class="font-bold text-yellow-500"><i class="fa-solid fa-database mr-2"></i>${db}</span>
                                <i id="icon-${dbId}" class="fa-solid fa-chevron-down transform transition-transform duration-200"></i>
                            </button>
                            <div id="${dbId}" class="hidden bg-gray-800 border-t border-gray-700 p-4">
                        `;

                            const tableKeys = Object.keys(tables);
                            if (tableKeys.length === 0) {
                                html += '<p class="text-gray-500 italic pl-4">No tables found.</p>';
                            } else {
                                html += '<div class="space-y-2 pl-2">';
                                for (const [table, rows] of Object.entries(tables)) {
                                    const tableId = `table-${db}-${table}`;
                                    html += `
                                <div class="border border-gray-700 rounded bg-gray-900">
                                    <button onclick="toggleAccordion('${tableId}')" class="w-full flex justify-between items-center p-3 hover:bg-gray-700 transition-colors text-left">
                                        <span class="font-semibold text-blue-300 text-sm"><i class="fa-solid fa-table mr-2"></i>${table}</span>
                                        <i id="icon-${tableId}" class="fa-solid fa-chevron-down transform transition-transform duration-200 text-xs"></i>
                                    </button>
                                    <div id="${tableId}" class="hidden p-3 border-t border-gray-700 overflow-x-auto">
                                `;

                                    if (rows.length === 0) {
                                        html += '<p class="text-gray-500 italic text-xs">No data rows found.</p>';
                                    } else {
                                        const columns = Object.keys(rows[0]);
                                        html += `<table class="min-w-full text-xs">
                                        <thead><tr class="bg-gray-800 text-gray-400 border-b border-gray-700">`;
                                        columns.forEach(col => html += `<th class="px-3 py-2 text-left font-medium uppercase tracking-wider">${col}</th>`);
                                        html += `</tr></thead><tbody class="divide-y divide-gray-800">`;

                                        rows.forEach(row => {
                                            html += `<tr class="hover:bg-gray-800 text-gray-300">`;
                                            columns.forEach(col => html += `<td class="px-3 py-2 whitespace-nowrap">${row[col]}</td>`);
                                            html += `</tr>`;
                                        });
                                        html += `</tbody></table>`;
                                    }
                                    html += `</div></div>`;
                                }
                                html += '</div>';
                            }
                            html += `</div></div>`;
                        }
                        html += '</div>';
                        content.innerHTML = html;
                    })
                    .catch(err => {
                        content.innerHTML = `<div class="text-red-500">Failed to load data: ${err}</div>`;
                    });
            }

            function toggleAccordion(id) {
                const el = document.getElementById(id);
                const icon = document.getElementById(`icon-${id}`);
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                } else {
                    el.classList.add('hidden');
                    icon.classList.remove('rotate-180');
                }
            }


            function closeModal() {
                document.getElementById('dataModal').classList.add('hidden');
            }

            function updateStatus() {
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => {
                        Object.keys(data).forEach(node => {
                            const info = data[node];
                            const el = document.getElementById(`node-${node}`);
                            const statusTxt = el.querySelector('.status-text');

                            el.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500', 'status-up', 'status-down');

                            if (info.status === 'up') {
                                if (node === 'proxysql') {
                                    el.classList.add('border-purple-500', 'status-up');
                                    statusTxt.textContent = 'ONLINE';
                                    statusTxt.className = 'text-xs text-purple-400 mt-1 status-text';
                                } else {
                                    el.classList.add('border-green-500', 'status-up');
                                    statusTxt.textContent = node === 'master' ? 'ONLINE' : `Lag: ${info.lag}s`;
                                    statusTxt.className = 'text-xs text-green-400 mt-1 status-text';
                                }
                            } else if (info.status === 'issues') {
                                el.classList.add('border-yellow-500');
                                statusTxt.textContent = 'ISSUES';
                                statusTxt.className = 'text-xs text-yellow-500 mt-1 status-text';
                            } else {
                                el.classList.add('border-red-500');
                                statusTxt.textContent = 'OFFLINE';
                                statusTxt.className = 'text-xs text-red-500 mt-1 status-text';
                            }
                        });
                    });
            }

            function runTest(service) {
                const logEl = document.getElementById(`log-${service}`);
                logEl.classList.remove('hidden');
                logEl.innerHTML += `<div class="text-gray-400">> Starting test...</div>`;
                logEl.scrollTop = logEl.scrollHeight;

                fetch(`/api/test/${service}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            logEl.innerHTML += `<div class="text-red-400">Error: ${data.error}</div>`;
                        } else {
                            logEl.innerHTML += `<div class="text-blue-300">> Write (Master): OK</div>`;
                            logEl.innerHTML += `<div class="text-gray-500 ml-2">Inserted: ${data.inserted_data}</div>`;
                            logEl.innerHTML += `<div class="text-green-300">> Read (${data.read_source}): ${data.read_status}</div>`;

                            if (data.data && data.data.length > 0) {
                                const latest = data.data[0];
                                logEl.innerHTML += `<div class="text-gray-300 ml-2">Latest: ${latest.name}</div>`;
                            } else {
                                logEl.innerHTML += `<div class="text-yellow-500 ml-2">Warning: No data found (Replication lag?)</div>`;
                            }
                        }
                        logEl.innerHTML += `<div class="border-b border-gray-700 my-1"></div>`;
                        logEl.scrollTop = logEl.scrollHeight;
                    })
                    .catch(err => {
                        logEl.innerHTML += `<div class="text-red-500">Request Failed</div>`;
                    });
            }

            // Poll status every 2 seconds
            setInterval(updateStatus, 2000);
            updateStatus();
        </script>
</body>

</html>